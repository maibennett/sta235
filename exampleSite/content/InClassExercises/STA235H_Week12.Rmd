---
title: "Week 12 - In-Class Exercise"
author: "STA 235H - Fall 2022"
date: ""
output: 
  html_document:
    css: style.css
    df_print: "kable"
---
<style type="text/css">
div.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}

@media only screen and (max-width: 600px) {
   body {
      margin: 0;
      padding: 0;
   }
   .sample {
      width: 100%;
   }
}
</style>

# Setup

In this exercise, we will be working with the same data as before!

You work at a marketing firm, and are trying to predict characteristics for different segments of your audience (customers from a car insurance company). You have the following dataset that will help you build your model:


```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(caret)
library(modelr)

# You will need to install these two packages:
library(rpart)
library(rattle)

marketing <- read.csv("https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week10/1_ModelSelection/data/marketing.csv")

# For simplicity, we will drop some variables, but you can use them all afterward if you want!
marketing <- marketing %>% select(Customer, Customer.Lifetime.Value, Response, Coverage, Education, EmploymentStatus,
                                  Gender, Income, Location.Code, Marital.Status, Monthly.Premium.Auto, 
                                  Months.Since.Last.Claim, Number.of.Policies,
                                  Policy.Type, Sales.Channel, Total.Claim.Amount, Renew.Offer.Type)
```

Here's the list of some variables in your dataset:

- `Customer`: Customer ID (*Note: ID variables are usually not predictors!*)
- `Customer.Lifetime.Value`: Estimate of the value of a customer (*In this example, this is what we will predict*)
- `Response`: Whether the client took the offer or not
- `Coverage`: Type of insurance coverage
- `Education`, `Gender`, `Income`, `Location.Code`, `Marital.Status`: Client's characteristics.
- `Renew.Offer.Type`: Offer made to the client (out of four different options)
- `Response`: Whether a customer responds to an offer or not.

Continuing with the task we were doing last week, run the following code and start from there:

```{r}
marketing <- marketing %>% select(-Customer) %>% mutate(Response = ifelse(Response=="No", 0, 1))

marketing <- marketing %>% mutate_if(is.character, as.factor)

set.seed(100) #Remember always to set seed before something random (in this case, sample())

n <- nrow(marketing) #Number of obs in our marketing dataset

train <- sample(1:n, nrow(marketing)*0.75) #Row numbers for 75% of our data (randomly selected)

train.data <- marketing %>% slice(train)
test.data <- marketing %>% slice(-train)

```

## Tasks

1) We are going to fit a regression tree to find the predicted values for Customer Lifetime Value. Using all the predictors in your dataset (except for `Response`), fit a regression tree. Start using `tuneLength = 20` to find the best neighborhood for your complexity parameter `cp` (plot your complexity parameter), and then use the argument `tuneGrid` to find the best model that you can. Use a 5-fold CV approach, and use a `set.seed(100)`.

**Q5: What is the best `cp` in this case?**

**Q6: What is the variable that is most predictive in your tree?**

**Q7: How does your model perform? Use an appropriate measure.**

