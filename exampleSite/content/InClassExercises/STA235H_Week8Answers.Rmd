---
title: "Week 8 - In-Class Exercise"
author: "STA 235H - Fall 2023"
date: ""
output: 
  html_document:
    css: style.css
    df_print: "kable"
---
<style type="text/css">
div.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}

@media only screen and (max-width: 600px) {
   body {
      margin: 0;
      padding: 0;
   }
   .sample {
      width: 100%;
   }
}
</style>

# Setup

Most (if not all) countries have a minimum legal drinking age (MLDA), and people often ask if this makes sense or not. Should the MLDA be higher or lower or even exist at all? One way to think about this is to look at the external benefits of this, for example in health outcomes or crime.

In this exercise, we will be working with real arrest data from the California Department of Justice's Monthly Arrest and Citation register (MACR) between 1979 and 2006 for individuals between 18 and 24 years old (data is from paper by Carpenter & Dobkin (2015)) to tackle this question.


```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(rdrobust)

mlda = read.csv("https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week8/1_RDD/data/mlda_18_24.csv")
```

Here's the list of some variables in your dataset:

- `age_days`: Age of the people arrested, in days (we will assume 7670 days = 21 years)
- `all`: Total number of arrests
- `felony`: Total number of felonies arrests
- `murder`: Total number of murder arrests
- `assault`: Total number of assault arrests
- `alcohol`: Total number of arrests related to alcohol
- `dui`: : Total number of driving under the influece arrests
- `female`: Proportion of female arrests (sim)

## Tasks

1) Let's start creating the variables we will need! Create a running variable `r` centered around the 21st birthday (*Hint: You will need to use age and subtract the cutoff*), and a treatment variable `treat` that takes the value of (1) if the person can legally drink and 0 in another case.

*Answer:*

We create the running variable such that individuals with $r>0$ are treated and $r<0$ are not (this consistency helps when using `rdrobust`).

```{r}
mlda = mlda %>% mutate(r = age_days - 7670,
                       treat = ifelse(r>=0, 1, 0))
```

2) Let's do some robustness checks first to make sure we can fit a RDD. Using `rdplot()`, show a plot for a RDD with `treat` as your outcome and `r` as your running variable. Do you see a discontinuity?

*Answer:*

We can see that there is a perfect discontinuity! 100% of individuals at the right of the cutoff are treated, and 100% at the left of the cutoff are not.

```{r, message = FALSE, warning = FALSE}
rdplot(mlda$treat, mlda$r, c = 0, x.label = "Days since 21st birthday", y.lab = "Legally able to drink (proportion)")
```

3) Let's do another robustness check, by checking the smoothness of covariates across the threshold. Using `rdplot()` and `rdrobust()`, fit a RDD with `female` as your outcome and `r` as your running variable. Should you see a discontinuity?

*Answer:*

We expect all baseline covariates to be smooth across the threshold (no jumps!), so we shouldn't expect a discontinuity in other variables (hint: you can think about this as a "balance" check for an RDD).

```{r}
rdplot(mlda$female, mlda$r, c = 0, x.label = "Days since 21st birthday", y.lab = "Female arrests (proportion)",
       col.dots = alpha("#F89441",0.3), col.lines = "#900DA4")
```

```{r}
summary(rdrobust(mlda$female, mlda$r, c = 0))
```


4) Finally, let's calculate an effect! Use a linear model (`lm()`) to estimate the RDD, using `all` as your outcome, and compare it to the results of `rdrobust()`. Include a plot using `rdplot()`. Which one do you think is a better estimate? Interpret your  effect.

*Answer:*

*For the interpretation, remember that this is valid for people exactly at the cutoff (Hint: Think of what the age for people at the cutoff is)*.

According to the linear model, the estimate is 34.7, while for rdrobust is 409.1. Why is there such a big difference?

```{r}
lm_rd = lm(all ~ treat*r, data = mlda)

summary(lm_rd)

summary(rdrobust(mlda$all, mlda$r, c = 0))
```

Let's compare the plots:

```{r, message=FALSE, warning=FALSE}
# Create a dataset for the treatment and the control group
# (we will use these for the regression lines!)
mlda_treat = mlda %>% filter(treat==1)
mlda_control = mlda %>% filter(treat==0)

# We will create a scatter plot with two smooth lines (regressions),
# one for each side of the cutoff.

ggplot(data = mlda, aes(x = r, y = all)) +
  geom_point(pch = 21, color = "grey", fill = alpha("grey",0.5)) +
  geom_smooth(data = mlda_treat, aes(x = r, y = all), method = "lm",
              se = FALSE, color = "purple") +
  geom_smooth(data = mlda_control, aes(x = r, y = all), method = "lm",
              se = FALSE, color = "darkorange") +
  theme_minimal() + xlab("Days since 21st birthday") + ylab("Number of alcohol arrests")

rdplot(mlda$all, mlda$r, c = 0, x.label = "Days since 21st birthday", y.label = "Number of alcohol arrests",
       col.dots = alpha("#F89441",0.3), col.lines = "#900DA4")
```


As you can see, the linear plot doesn't do a good job approximating the data for the control group, so it seems like there is a much smaller effect of MLDA than there actually is.