---
title: "Some Useful R Code"
author: "STA 235H - Fall 2022"
date: "August 16th, 2022"
output: 
  html_document:
    css: style.css 
    toc: no
  pdf_document: 
    latex_engine: xelatex
    toc: no
---
<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}

@media only screen and (max-width: 600px) {
   body {
      margin: 0;
      padding: 0;
   }
   .sample {
      width: 100%;
   }
}
</style>


# Introduction

This document is meant to show you some useful code that we will be using in this class. However, **it is not meant to be a comprehensive list of tips and tricks** for R users. If you want a deeper dive into R, please check the external resources that have been added on the [course website](https://sta235.netlify.app/resources/).

# Starting with R

## Check your version

For this class, make sure you have the most updated version of R (you can check your \R version by typing `version` on the console). If your version is older than `R 4.2.1`, please [download]() and install the latest \R version.

## Code header

It's always good practice to have some annotations on your code, especially on the header, so future you remembers what past you was doing (sometimes they don't get along). This is personal preference, but for simple projects, I tend to have a descriptive header as following:

```{r}
################################################################################
### Title: My Project
### Author: Magdalena Bennett
### Created on: 2022/08/04
### Last edit: 2022/08/16
###      Edit: [MB] - Created script
###      Edit: [MB] - Included additional data
################################################################################

# Clears memory
rm(list = ls())
# Clears console
cat("\014")
```

This is particularly helpful when you are working with collaborators, so you can keep track of the main edits.

Another slightly more sofisticated but incredibly useful way of keep track of changes in R scripts is using [Github](https://www.github.com). This goes beyond the scope of this document, but I highly suggest you look into it if you plan of coding more frequently (*Tip: Look into Github Desktop if you've never used git*).

Note that I also include code to clear the memory and the console, to make sure I'm starting from scratch when running code. This is very useful to make sure your code is reproducible, because others will most likely start with a clear memory as well.

## Load your packages

One good practice is to load all required packages for your code at the top of your script. For example, for this document I will be using the following packages:

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(patchwork)
library(AER)
```

Make sure your packages are installed, or the previous code will give you an error. If one or more of the packages are not installed, you need to install them only once as following:

```{r, message=FALSE, warning=FALSE, eval=FALSE}
install.packages("AER")
```

**Do not include this line of code on your R script**. If you do, every time you run the code, you will be re-installing the package and that is not necessary (also it may lead to errors or inconsistencies if the package is updated).

For this course, we will almost always be using the `tidyverse` package, which include an array of other packages as well (e.g. `dplyr`, `ggplot2`, etc.). If you load the `tidyverse`, there's no need to include these other ones. Also, make sure you load the packages you need, and not every package you have ever used. **Keep your code clean**.

## Opening your data

How you load your data depends on how your data is stored (csv? json? dta?). In this course, we will usually use CSV data (Comma-Separated Values), which you can load as following:

```{r, echo = TRUE, warning = FALSE, message = FALSE}
d <- read.csv("https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/UsefulRCode/data/cereal.csv")
```

In this case, we are loading the data directly from a web repository, but you can also load it with local data (e.g. changing the file to `"C:/Documents/DS/cereal.csv"`).

*Note: Always make sure you look at your dataset after you load it, to make sure you are reading it correctly*.

If you are using other type of data, there other packages that might be useful, such as `haven`, `readxl`, or `rjson`, among others.  

# Data Wrangling

Now that we have setup our session and have our data loaded, let's start wrangling the data (e.g. setting it up for analysis). We will be using the `cereal.csv` data we previously loaded, and you can check out more information about this dataset [here](http://lib.stat.cmu.edu/datasets/1993.expo/).

## Inspect data

We can look at some of the data with plots. For example, a histogram:

```{r, echo = TRUE, warning = FALSE, message = FALSE}
ggplot(data = d, aes(x = rating)) +
  geom_histogram(color = "skyblue", fill = "white", lwd = 1.1, bins = 30) +
  xlab("Rating") + ylab("Count") +
  ggtitle("Rating for Cereals") + 
    theme_minimal()
```

In `ggplot`, we always load the data and pass the aesthetics (e.g. variables you want to plot). There are many options to personalize your plots! Make sure they are readable and provide the information you want to convey. For that, titles, captions, axis labels, scale, etc., are always important. In this case, **looks ARE important** (in order to convey information).

Besides histograms, we can have density plots (`geom_density()`), scatter plots (`geom_point()`), and line plots (`geom_line`), among many, many others.

For example, let's look at a scatter plot between `sugars` and `rating`:

```{r, echo = TRUE, warning = FALSE, message = FALSE}
ggplot(data = d, aes(y = rating, x = sugars)) +
  geom_point(color = "skyblue") +
  xlab("Sugars") + ylab("Ratings") +
  ggtitle("Rating vs Sugars") + 
    theme_minimal()
```

We can also show two plots side-by-side using the `patchwork` package:

```{r, echo = TRUE, warning = FALSE, message = FALSE}
hist1 <- ggplot(data = d, aes(x = rating)) +
  geom_histogram(color = "skyblue", fill = "white", lwd = 1.1, bins = 30) +
  xlab("Rating") + ylab("Count") +
  ggtitle("Rating for Cereals") + 
    theme_minimal()

scat1 <- ggplot(data = d, aes(y = rating, x = sugars)) +
  geom_point(color = "skyblue") +
  xlab("Sugars") + ylab("Ratings") +
  ggtitle("Rating vs Sugars") + 
    theme_minimal()

hist1 + scat1
```

One thing that you might want to do when inspecting your data is to know how many observations/groups you have available. For example, how many different manufacturers do we have and do they make higher or lower calories cereal?

For this, the `group_by` function could be very useful. What it does is group your dataset by whatever variable(s) you want, and then do operations at that group-level (e.g. mutate or summarize):

```{r, echo = TRUE, warning = FALSE, message = FALSE}
d %>% group_by(mfr) %>% summarize(n_cereals = n(),
                                  mean_calories = mean(calories))
```

From the previous code, you can see that now we are creating two new variables: `n_cereals`, which is the number of different cereals in our dataset *by manufacturer*, and `mean_calories`, which captures the average calories of cereals made by that manufacturer. Also, what are the dimensions of our new dataset? Can you guess why?

## Cleaning data

One important task (and usually the one that takes the most time) is cleaning your data. In this section, we will review some of the main functions you will need to remove observations, create new variables, change existing ones, etc.

### Let's apply a filter

Many times, you will have a dataset that contains observations that you may want to remove (e.g. a specific population or missing observations). These decisions are not automatic, and you should always explain *why* you are removing observations. But for now, let's get to the code. For this example, we will be suing the `CreditCard` dataset from the `AER` package (type `?CreditCard` to get an idea of what the dataset contains):

```{r}
data("CreditCard")
```

Let's keep a subset of 


We now have `r nrow(sports)` observations

**4) Transform revenue and expenditure variables into thousands of USD (instead of USD). Plot a histogram for total revenue and another histogram for total expenditure (they do not need to be on the same plot). What can you say about these plots? (1 sentence)** *(7 points)*

```{r, echo = TRUE, warning = FALSE, message = FALSE}
library(ggplot2)
library(patchwork)

sports <- sports %>% mutate(total_exp_menwomen = total_exp_menwomen/1000,
                            exp_men = exp_men/1000,
                            exp_women = exp_women/1000,
                            total_rev_menwomen = total_rev_menwomen/1000,
                            rev_men = rev_men/1000,
                            rev_women = rev_women/1000)

g_exp <- ggplot(data = sports, aes(x = total_exp_menwomen)) +
  geom_histogram(color = "skyblue", fill = "white", lwd = 1.1, bins = 50) +
  xlab("Expenditure") + ylab("Count") +
    theme_minimal()

g_rev <- ggplot(data = sports, aes(x = total_rev_menwomen)) +
  geom_histogram(color = "skyblue", fill = "white", lwd = 1.1, bins = 50) +
  xlab("Revenue") + ylab("Count") +
    theme_minimal()

g_exp + g_rev
```

These distributions are skewed, and have a long right tail.

**5) Now transform the variables into logarithms and create the same plots. What can you say now about these graphs? (1 sentence)** *(5 points)*

```{r, echo = TRUE, warning = FALSE, message = FALSE}
sports <- sports %>% mutate(log_total_exp = log(total_exp_menwomen),
                            log_total_rev = log(total_rev_menwomen))

g_exp <- ggplot(data = sports, aes(x = log_total_exp)) +
  geom_histogram(color = "skyblue", fill = "white", lwd = 1.1, bins = 50) +
  xlab("log(Expenditure)") + ylab("Count") +
    theme_minimal()

g_rev <- ggplot(data = sports, aes(x = log_total_rev)) +
  geom_histogram(color = "skyblue", fill = "white", lwd = 1.1, bins = 50) +
  xlab("log(Revenue)") + ylab("Count") +
    theme_minimal()

g_exp + g_rev
```

By transforming expenditure and revenue with log, we can see that now they distribute normally. 

**6) Fit the following model using the data:**
$$\log(TotalRevenue) = \beta_0 + \beta_1\log(TotalExpenditure) + \beta_2 Year + \varepsilon$$
**Fit the regression, show your results, and interpret $\hat{\beta}_1$** *(8 points)*

```{r, echo = TRUE, warning = FALSE, message = FALSE}
lm1 <- lm(log_total_rev ~ log_total_exp + year, data = sports)

summary(lm1)
```

An increase in 1% of total expenditures is associated with a increase of 0.93% in total revenue, holding year constant, which is statistically significant at a 1% level.


---

Now that we have analyzed some general associations, let's look at whether the association between revenue and expenditure is different for men and women's sports.

For this, we will use a transformation of the previous dataset, where we will append data for men and women separately at the institution level to make the analysis easier. You can find the new dataset here:

```{r, echo = FALSE, warning = FALSE, message = FALSE}
sports_m <- sports %>% select(rev_men, exp_men, year, ef_male_count, partic_men, unitid) %>% group_by(unitid, year) %>%
  summarise(revenue = sum(rev_men), expenditure = sum(exp_men), enrollment = mean(ef_male_count, na.rm = TRUE), partic = sum(partic_men)) %>%
  mutate(women = 0) %>% filter(expenditure>0 & revenue>0)

sports_w <- sports %>% select(rev_women, exp_women, year, ef_female_count, partic_women, unitid) %>% group_by(unitid, year) %>%
  summarise(revenue = sum(rev_women), expenditure = sum(exp_women), enrollment = mean(ef_female_count, na.rm = TRUE), partic = sum(partic_women)) %>%
  mutate(women = 1) %>% filter(expenditure>0 & revenue>0)

sports_mw <- bind_rows(sports_m, sports_w)# append the two previous datasets

#write.csv(sports_mw, file = "C:/Users/mc72574/Dropbox/UT/Teaching/2022Fall_STA235H/homework/homework1/data/sports_mw.csv", row.names = FALSE)
  
```

```{r, message=FALSE, warning=FALSE, echo=TRUE, eval = FALSE}
sports_mw <- read.csv("https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Assignments/Homework/HW1/data/sports_mw.csv")
```

In `sports_mw`, we have the same data as before, but at the institution-year-gender level:

|variable             |class     |description |
|:--------------------|:---------|:-----------|
|unitid               |integer   | School ID |
|year                 |integer   | year, which is year: year + 1, eg 2015 is 2015 to 2016 |
|women                |integer   | 1: data refers to women sports, and 0: data refers to male sports|
|revenue              |double    | Total revenue for all sports at the unitid-year-women level, measured in 1,000 USD |
|expenditure          |double    | Total expenditure for all sports at the unitid-year-women level, measured in 1,000 USD  |
|enrollment           |double    | Enrollment at the unitid-year-women level |
|partic               |double    | Total participation in sports at the unitid-year-women level |


**7) Using the dataset `sports_mw`, fit the following regression:** *(12 points)*

$$\begin{eqnarray*}
\log(Revenue) = &\beta_0& + \beta_1Participation + \beta_2Enrollment + \beta_3\log(Expenditure) + \\&\beta_4&Women + \beta_5log(Expenditure)\times Women+ \varepsilon
\end{eqnarray*}$$
**What is the association between revenue and expenditure for men's sports? and for women's? Are they significantly different? Explain**

```{r, echo = TRUE, warning = FALSE, message = FALSE}

sports_mw <- sports_mw %>% mutate(log_revenue = log(revenue),
                                  log_expenditure = log(expenditure))

lm2 <- lm(log_revenue ~ partic + enrollment + log_expenditure*women, data = sports_mw)

summary(lm2)

```

- For a 1% increase in expenditure, male sports increase their revenue, on average, by 1.019%, holding other variables constant. The association is statistically significant at 1% level.

- For a 1% increase in expenditure, female sports increase their revenue by 0.956%, holding other variables constant. The association is statistically significant at a 1% level.

- The difference in the association between revenue and expenditure for men and women's sports is statistically significant at a 1% level, where the association for female's is -0.006% lower than for male's sports.

---

# Task 2 - All about that real estate bubble (45 points)

As you may have noticed, real estate prices are soaring in some cities, and 

**1) Create a scatter plot for price (y-axis) and square-footage (x-axis)**

**2) Using the previous plot and whatever regression(s) model(s) you see fit, which of the following statements better describes the relation between price and square-footage?** (5 points)

a) The relation is linear and positive
b) The relation is quadratic and positive
c) The relation is not statistically significant
d) We cannot properly assess the relation with this data

**2) Fit the following model:**
$$Price = \beta_0 + \beta_1 NumRooms + \beta_2 NumBathrooms + \beta_3 SqFootage + \beta_4...$$

**What is the average price for a house with 2 bed/1 bath and 700 sqft?**

**3) Interpret the intercept for the previous regression. What is it capturing?**

**4) Fit the following quadratic model:**

$$Price = \beta_0 + \beta_1 SqFootage + \beta_2 SqFootage^2 + \varepsilon$$

**Based on the previous model, what is the relation between price and square footage?**

---

# Task 3 - Understanding regression outputs (10 points)

**1) Which column shows the point estimates?** (2 points)

**2) What is the t-statistic that is missing in the previous table?** (2 points)

**3) What is the null hypothesis that is being tested if you look at column 4?** (2 points)

**4) Looking at the previous table, which of the following statements is/are true?** (2 points)

- The relation between X1 and Y is larger than the relation between X2 and Y

- Looking at the p-value, we can accept that the relation between X3 and Y is 0.

- One-unit increase in X1 is associated to an average increase of B1% in Y, holding other variables constant.

- 1% increase in X1 is associated to an average inrease of B1 in Y, holding other variables constant.

- [COMPLETE]

**5) Complete the following code:** (2 points)

