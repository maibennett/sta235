---
title: "STA 235H - Randomized Controlled Trials II"
subtitle: "Fall 2021"
author: "McCombs School of Business, UT Austin"
output:
  xaringan::moon_reader:
    css: [xaringan-themer.css]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
      beforeInit: ["macros.js"]
    includes:
      in_header: ["header.html"]
---

<!-- <script type="text/javascript"> -->
<!-- MathJax.Hub.Config({ -->
<!--   "HTML-CSS": { -->
<!--     preferredFont: null, -->
<!--     webFont:  "Neo-Euler" -->
<!--   } -->
<!-- }); -->
<!-- </script> -->

```{r setup, include=FALSE, warning=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(fig.showtext = TRUE)
```

```{r xaringan-themer, include=FALSE, warning=FALSE, message=FALSE}
library(xaringanthemer)

theme_xaringan(
  text_color = "#333f48",
  background_color = "#FFFFFF",
  accent_color = "#900DA4",
  text_font = "Fira Mono",
  text_font_use_google = TRUE,
  title_font = "Yanone Kaffeesatz",
  title_font_use_google = TRUE
)

style_mono_accent(
  #base_color = "#bf5700",
  extra_fonts = list(google_font("Fira Sans","200","300","400","500","600"),
                     google_font("Fira Sans Condensed","200","300","400","500","600")),
  base_color = "#333f48",
  header_font_google = google_font("Yanone Kaffeesatz","200","300","400","500","600","700"),
  text_font_google   = google_font("Jost"),
  code_font_google   = google_font("Fira Mono"),
  text_bold_color = "#333f48",
  text_font_size = "115%",
  colors = c(
    lightgrey = "#C0C0C0",
    red = "#f34213",
    purple = "#900DA4",
    darkpurple = "#61077a",
    darkorange = "#db5f12",
    orange = "#ff8811",
    green = "#136f63",
    white = "#FFFFFF"),
  extra_css = list(
    ".remark-slide table" = list("display" = "table",
                   "width" = "80%",
                   "text-align" = "left"),
    ".remark-slide-number" = list("display" = "none"),
    ".strong" = list("font-weight" = "400"),
    ".big" = list("font-size" = "350%",
                     "font-family" = "Yanone Kaffeesatz",
                     "font-weight"="400"),
    ".small" = list("font-size" = "80%"),
    ".tiny" = list("font-size" = "50%"),
    ".large" = list("font-size" = "150%"),
    ".source" = list("color" = "#8c8c8c",
                     "font-size" = "80%"),
    ".remark-slide table td#highlight" = list("background-color" = "#eee1f0",
                                  "color" = "#900DA4",
                                  "font-weight" = "500"),
   # ".remark-slide table thead th" = list(),
    ".title-slide h1" = list("font-weight" = "500"),
    ".title-slide h2" = list("font-weight" = "400",
                             "font-size" =  "170%"),
    ".title-slide h3" = list("font-family" = "Jost",
                             "font-size" = "100%",
                             "font-weight" = "200"),
    ".center2" = list("margin" = "0",
                      "position" = "absolute",
                      "top" = "50%",
                      "left" = "50%",
                      "-ms-transform" = "translate(-50%, -50%)",
                      "transform" = "translate(-50%, -50%)"),
   ".bottom2" = list("margin" = "0",
                      "position" = "absolute",
                      "top" = "90%",
                      "left" = "10%",
                      "-ms-transform" = "translate(-10%, -90%)",
                      "transform" = "translate(-10%, -90%)"),
    ".section-title h1" = list("color" = "#FFFFFF",
                               "font-size" = "2.3em",
                               "line-height" = "1.3"),
    ".sp-after-half" = list("margin-bottom" = "0.7em !important"),
    ".box-1,.box-1a,.box-1s,.box-1b,.box-1l,.box-1LA,.section-title-1" = list("background-color" = "#0D0887"),
    ".box-2,.box-2a,.box-2s,.box-2b,.box-2l,.box-2LA,.section-title-2" = list("background-color" = "#5601A4"),
    ".box-3,.box-3a,.box-3s,.box-3b,.box-3l,.box-3LA,.section-title-3" = list("background-color" = "#900DA4"),
    ".box-4,.box-4a,.box-4s,.box-4b,.box-4l,.box-4LA,.section-title-4" = list("background-color" = "#BF3984"),
    ".box-5,.box-5a,.box-5s,.box-5b,.box-5l,.box-5LA,.section-title-5" = list("background-color" = "#E16462"),
    ".box-6,.box-6a,.box-6s,.box-6b,.box-6l,.box-6LA,.section-title-6" = list("background-color" = "#F89441"),
    ".box-7,.box-7a,.box-7s,.box-7b,.box-7l,.box-7LA,.section-title-7" = list("background-color" = "#FCCE25"),
   
    ".box-1trans,.box-2trans,.box-3trans,.box-4trans,.box-5trans,.box-6trans,.box-7trans" = list("background-color" = "#FFFFFF",
                                                                                                 "font-family" = "Yanone Kaffeesatz",
                                                                                                 "border-radius" = "15px",
                                                                                                 "margin" = "0em auto",
                                                                                                 "overflow" = "hidden",
                                                                                                 "padding" = "0.4em 0.4em",
                                                                                                 "font-weight" = "600",
                                                                                                 "font-size" = "31px",
                                                                                                 "display" = "table",
                                                                                                 "text-align" = "center",
                                                                                                 "border-width" = "thick",
                                                                                                 "color" = "#333f48"),
   
       ".box-1Trans,.box-2Trans,.box-3Trans,.box-4Trans,.box-5Trans,.box-6Trans,.box-7Trans" = list("background-color" = "#FFFFFF",
                                                                                                 "font-family" = "Yanone Kaffeesatz",
                                                                                                 "border-radius" = "15px",
                                                                                                 "margin" = "0em auto",
                                                                                                 "overflow" = "hidden",
                                                                                                 "padding" = "0.4em 0.4em",
                                                                                                 "font-weight" = "600",
                                                                                                 "font-size" = "51px",
                                                                                                 "display" = "table",
                                                                                                 "text-align" = "center",
                                                                                                 "border-width" = "thick",
                                                                                                 "color" = "#333f48"),
   
       ".box-1transl,.box-2transl,.box-3transl,.box-4transl,.box-5transl,.box-6transl,.box-7transl" = list("background-color" = "#FFFFFF",
                                                                                                           "font-family" = "Yanone Kaffeesatz",
                                                                                                           "border-radius" = "15px",
                                                                                                           "left" = "0px",
                                                                                                           "overflow" = "hidden",
                                                                                                           "padding" = "0.4em 0.4em",
                                                                                                           "font-weight" = "600",
                                                                                                           "font-size" = "31px",
                                                                                                           "display" = "table",
                                                                                                           "text-align" = "left",
                                                                                                           "border-width" = "thick",
                                                                                                           "color" = "#333f48"),
   
   
    ".box-1trans,.box-1transl,.box-1Trans" = list("border"="5px solid rgba(13, 8, 135,1)"),
    ".box-2trans,.box-2transl,.box-2Trans" = list("border"="5px solid rgba(86, 1, 164,1)"),
    ".box-3trans,.box-3transl,.box-3Trans" = list("border"="5px solid rgba(144, 13, 164,1)"),
    ".box-4trans,.box-4transl,.box-4Trans" = list("border"="5px solid rgba(191, 57, 132,1)"),
    ".box-5trans,.box-5transl,.box-5Trans" = list("border"="5px solid rgba(225, 100, 98,1)"),
    ".box-6trans,.box-6transl,.box-6Trans" = list("border"="5px solid rgba(248, 148, 65,1)"),
    ".box-7trans,.box-7transl,.box-7Trans" = list("border"="5px solid rgba(252, 206, 37,1)"),

   
   ".box-1t,.box-1tL,.section-title-1t" = list("background-color" = "rgba(13, 8, 135,0.3)",
                                      "color"="rgba(13, 8, 135,1)",
                                      "font-family" = "Yanone Kaffeesatz",
                                                                    "border-radius" = "15px"),
    ".box-2t,.box-2tL,.section-title-2t" = list("background-color" = "rgba(86, 1, 164,0.3)",
                                       "color" = "rgba(86, 1, 164,1)",
                                       "font-family" = "Yanone Kaffeesatz",
                                                                    "border-radius" = "15px"),
    ".box-3t,.box-3tL,.section-title-3t" = list("background-color" = "rgba(144, 13, 164,0.3)",
                                       "color" = "rgba(144, 13, 164,1)",
                                       "font-family" = "Yanone Kaffeesatz",
                                                                    "border-radius" = "15px"),
    ".box-4t,.box-4tL,.section-title-4t" = list("background-color" = "rgba(191, 57, 132,0.3)",
                                       "color" = "rgba(191, 57, 132,1)",
                                       "font-family" = "Yanone Kaffeesatz",
                                                                    "border-radius" = "15px"),
    ".box-5t,.box-5tL,.section-title-5t" = list("background-color" = "rgba(225, 100, 98,0.3)",
                                       "color" = "rgba(225, 100, 98,1)",
                                       "font-family" = "Yanone Kaffeesatz",
                                                                    "border-radius" = "15px"),
    ".box-6t,.box-6tL,.section-title-6t" = list("background-color" = "rgba(248, 148, 65,0.3)",
                                       "color" = "rgba(248, 148, 65,1)",
                                       "font-family" = "Yanone Kaffeesatz",
                                                                    "border-radius" = "15px"),
    ".box-7t,.box-7tL,.section-title-7t" = list("background-color" = "rgba(252, 206, 37,0.3)",
                                       "color" = "rgba(252, 206, 37,1)",
                                       "font-family" = "Yanone Kaffeesatz",
                                                                    "border-radius" = "15px"),
   
   ".box-7t, .box-6t, .box-5t, .box-4t, .box-3t, .box-2t, .box-1t" = list("margin" = "0em auto",
                                                                    "overflow" = "hidden",
                                                                    "padding" = "0.4em 0.4em",
                                                                    "font-weight" = "600",
                                                                    "font-size" = "31px",
                                                                    "display" = "table",
                                                                    "text-align" = "center",
                                                                    "border-radius" = "15px"),
   
   ".box-7tL, .box-6tL, .box-5tL, .box-4tL, .box-3tL, .box-2tL, .box-1tL" = list("margin" = "0em auto",
                                                                    "overflow" = "hidden",
                                                                    "padding" = "0.4em 0.4em",
                                                                    "font-weight" = "600",
                                                                    "font-size" = "50px",
                                                                    "display" = "table",
                                                                    "text-align" = "center",
                                                                    "border-radius" = "15px"),
   
    ".box-7, .box-6, .box-5, .box-4, .box-3, .box-2, .box-1" = list("color" = "#FFFFFF",
                                                                    "margin" = "0em auto",
                                                                    "overflow" = "hidden",
                                                                    "padding" = "0.4em 0.4em",
                                                                    "font-weight" = "600",
                                                                    "font-size" = "31px",
                                                                    "display" = "table",
                                                                    "text-align" = "center",
                                                                    "font-family" = "Fira Sans",
                                                                    "border-radius" = "15px"),
    ".box-7a, .box-6a, .box-5a, .box-4a, .box-3a, .box-2a, .box-1a" = list("color" = "#FFFFFF",
                                                                          "left" = "0px",
                                                                          "overflow" = "hidden",
                                                                      "padding" = "0.4em 0.4em",
                                                                      "font-weight" = "600",
                                                                      "font-size" = "25px",
                                                                      "display" = "table",
                                                                      "text-align" = "center",
                                                                      "font-family" = "Fira Sans",
                                                                    "border-radius" = "15px"),
   ".box-7s, .box-6s, .box-5s, .box-4s, .box-3s, .box-2s, .box-1s" = list("color" = "#FFFFFF",
                                                                          "left" = "0px",
                                                                          "overflow" = "hidden",
                                                                      "padding" = "0.2em 0.2em",
                                                                      "font-weight" = "400",
                                                                      "font-size" = "100%",
                                                                      "display" = "inline",
                                                                      "text-align" = "center",
                                                                      "font-family" = "Fira Sans",
                                                                    "border-radius" = "15px"),
       ".box-7b, .box-6b, .box-5b, .box-4b, .box-3b, .box-2b, .box-1b" = list("color" = "#FFFFFF",
                                                                          "left" = "0px",
                                                                          "overflow" = "hidden",
                                                                      "padding" = "0.4em 0.4em",
                                                                      "font-weight" = "600",
                                                                      "font-size" = "25px",
                                                                      "display" = "table",
                                                                      "text-align" = "left",
                                                                      "font-family" = "Fira Sans",
                                                                    "border-radius" = "15px"),
   ".box-7l, .box-6l, .box-5l, .box-4l, .box-3l, .box-2l, .box-1l" = list("color" = "#FFFFFF",
                                                                    "margin" = "0em auto",
                                                                    "overflow" = "hidden",
                                                                    "padding" = "0.4em 0.4em",
                                                                    "font-weight" = "600",
                                                                    "font-size" = "45px",
                                                                    "display" = "table",
                                                                    "text-align" = "center",
                                                                      "font-family" = "Yanone Kaffeesatz",
                                                                    "border-radius" = "15px"),
   ".box-7LA, .box-6LA, .box-5LA, .box-4LA, .box-3LA, .box-2LA, .box-1LA" = list("color" = "#FFFFFF",
                                                                    "margin" = "0em auto",
                                                                    "overflow" = "hidden",
                                                                    "padding" = "0.4em 0.4em",
                                                                    "font-weight" = "600",
                                                                    "font-size" = "55px",
                                                                    "display" = "table",
                                                                    "text-align" = "center",
                                                                      "font-family" = "Yanone Kaffeesatz",
                                                                    "border-radius" = "15px"),
   ".medium" = list("font-size" = "35px"),
   
   ".medium30" = list("font-size" = "30px"),
   
   ".jost-normal" = list("font-family" = "Jost",
                         "font-size" = "31px"),
   
   ".image-80 img" = list("scale" = "80%"),
   ".pull-left-little_l" = list("float" = "left",
                                "width" = "67%"),
   ".pull-right-little_l" = list("float" = "right",
                                "width" = "27%"),
   ".pull-left-little_r" = list("float" = "left",
                                "width" = "27%"),
   ".pull-right-little_r" = list("float" = "right",
                                "width" = "67%")


  )
)

#,"li" = list("font-size" = "150%")
#    "li" = list("font-size" = "110%"),
#    "ul" = list("font-size" = "110%"),
#color palette
#5601A4
#900DA4
#F89441
#FCCE25

knitr::opts_chunk$set(message = FALSE, warning = FALSE)

```
```{css, echo = FALSE}

.small .remark-code { /*Change made here*/
  font-size: 80% !important;
}

.tiny .remark-code { /*Change made here*/
  font-size: 90% !important;
}
```

```{r setup2, echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
library(showtext)
library(xaringanExtra)
library(htmltools)
library(paletteer)
library(reactable)
library(htmlwidgets)
library(webshot2)
library(tidyverse)
library(extrafont)
library(hrbrthemes)
library(firasans)
# for windows
windowsFonts(sans = "Fira")
loadfonts(device="win")
loadfonts(device="postscript")

xaringanExtra::use_scribble()

htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```

```{r fonts, message=FALSE, echo=FALSE, warning=FALSE}
font.add.google("Fira Sans Condensed", "Fira Sans Condensed")
font.add.google("Fira Sans", "Fira Sans")
```
# Some announcements

.box-4LA[Homework 2 is due on Thursday]

<br>

--


- Please remember to (1) <u>submit on time</u> or (2) <u>fill out the extension form</u>

  - Reach out to the instruction team if you have any issues.
  
--

- Following the analytics for the course website, **.darkorange[less than 50% of students check out the R code]**:

  - Review the scripts and answer the questions there! (good practice for the midterm, too).

---
# Last week

.pull-left[

![:scale 80%](https://media.giphy.com/media/YMwRxPhWq5SoIBPvMY/giphy.gif?cid=ecf05e47xugy72kyps7kvffoanb4duyaufr9d8um1kdplohn&rid=giphy.gif&ct=g)
]
.pull-right[
- Finished our chapter on **.darkorange[causal inference framework]**.

- Started talking about **.darkorange[Randomized Controlled Trials]**:

  .box-2[Assumptions: The power of randomization]
]

---
# Today

.pull-left[
- Continue with **.darkorange[randomized controlled trials]**:

  .box-4[Design: What should we consider?]
  
  .box-7[Limitations: Gold Standard?]
  
- Comparison between **.darkorange[observational]** studies and **.darkorange[RCTs]**
  
]

.pull-right[
![](https://media.giphy.com/media/l3dj09hpsfuYkijDi/giphy.gif?cid=ecf05e47u8xm2usaj4n89v5gkwypeewheumjciut4l3vw5ph&rid=giphy.gif&ct=g)
]
---
background-position: 50% 50%
class: left, bottom, inverse
.big[
Design: How do we randomize?
]


---
# How do we randomize?


.box-5[Coin flip*]

--

E.g., in `R`:

```{r}
id <- seq(1,1000)

set.seed(100)

data <- data.frame("id" = id) %>% mutate(z = sample(c(0,1), size = 1000, 
                                                    replace = TRUE,
                                                    prob = c(0.5, 0.5)))

```

---
# How do we randomize?

.box-5[Coin flip*]

E.g., in `R`:

```{r}
id <- seq(1,1000)

set.seed(100) #<<

data <- data.frame("id" = id) %>% mutate(z = sample(c(0,1), size = 1000, 
                                                    replace = TRUE,
                                                    prob = c(0.5, 0.5)))
```

---
# How do we randomize?

.box-5[Coin flip*]

E.g., in `R`:

```{r}
id <- seq(1,1000)

set.seed(100)

data <- data.frame("id" = id) %>% mutate(z = sample(c(0,1), size = 1000, #<<
                                                    replace = TRUE, #<<
                                                    prob = c(0.5, 0.5))) #<<

```

---
# How do we randomize?

.box-5[Coin flip*]

E.g., in `R`:

```{r, eval = FALSE}
id <- seq(1,1000)

set.seed(100)

data <- data.frame("id" = id) %>% mutate(z = sample(c(0,1), size = 1000,
                                                    replace = TRUE,
                                                    prob = c(0.5, 0.5)))

data %>% group_by(z) %>% count() #<<
```
---
# How do we randomize?

.box-5[Coin flip*]

E.g., in `R`:

```{r, eval = TRUE}
id <- seq(1,1000)

set.seed(100)

data <- data.frame("id" = id) %>% mutate(z = sample(c(0,1), size = 1000,
                                                    replace = TRUE,
                                                    prob = c(0.5, 0.5)))

data %>% group_by(z) %>% count() #<<
```

---
.center2[
.box-3LA[How do we check that randomization was done correctly?]
]

---
# Checking for balance

.small[
```{r, message=FALSE, warning=FALSE}
library(modelsummary)

d <- read.csv("https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week4/2_RCT/data/covariates_example.csv")

head (round(d,3))
```
]
---
# Checking for balance

.pull-left[
.small[
```{r, message=FALSE, warning=FALSE}
d_bal <- d %>% select(z, starts_with("x"))

datasummary_balance(~ z, data = d_bal, fmt = 2, dinm_statistic = "p.value")
```
]]
.pull-right[
- **.darkorange[Columns of interest]**:

  - Diff in Means: Difference in means between treat (col. 3) and control group (col. 1)
  
  - p: P-value for the difference in means (whether is statistically significant or not.)
]

---
.center2[.box-6LA[Randomization assures balance *in expectation*]]

---
# Can we ensure balance?

- In RCTs, in general, you can't ensure balance on all covariates.

- But you can **.darkorange[stratify]**!
--

- Stratification means dividing your data into different stratas or groups *S*, based on one or more covariates.

- Then, you randomize in the same way *within strata*.

---
# Randomization of treatment

.center[
![:scale 80%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/study1.png)
]

---
# Randomization of treatment with no strata

.center[
![:scale 80%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/study2.png)
]

---
# Randomization of treatment with strata

.center[
![:scale 80%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/study3.png)
]

---
background-position: 50% 50%
class: left, bottom, inverse
.big[
RCTs in Practice
]

---
# Let's look at some data

.pull-left[
- "Get out the Vote" Large-Scale Mobilization experiment (Arceneaux, Gerber, and Green, 2006)
  
  - "Households containing one or two registered voters where **.darkorange[randomly assigned]** to treatment or control groups"
  
  - Treatment: GOTV phone calls
  
  - Stratified RCT: Two states divided into competitive and noncompetitive 
]
.pull-right[
![:scale 100%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/vote.jpg)
]

---
# Checking for balance

.center[
![](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/balance_table.png)
]

---
# Estimating the effect

- Depending on the design, usually you can **.darkorange[compare group means]** or fit a **.darkorange[simple regression]**

--

$$\frac{1}{N_T}\sum_{i\in T}Y_i - \frac{1}{N_C}\sum_{i\in C}Y_i$$

$$Y_i = \beta_0 + \beta_1 Z_i + \varepsilon_i$$

--

.box-4[How do we incorporate stratification here?]

---
# Estimating the effect

- In stratified RCTs, we need to consider the strata!

--

- Run a regression with *fixed effects by strata*

.box-6[$$Y_i = \beta_0 + \beta_1 Z_i + \gamma_s + \varepsilon_i$$]


---
# Estimating the effect

```{r, echo=FALSE}
d <- read.csv("https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/data/voters_covariates.csv")

# Drop variables with unlisted phone numbers
d_s1 <- d %>% filter(!is.na(treat_real))
```
.small[
```{r, echo = TRUE, message = FALSE}
library(estimatr)

d_s1$strata <- interaction(d_s1$state, d_s1$competiv)

summary(lm_robust(vote02 ~ treat_real + strata, data = d_s1))
```
]

---
# Estimating the effect

- One important thing to note in the previous analysis is that **.darkorange[assignment to treatment]** $\neq$ **.darkorange[contact]**

```{r, echo = TRUE, message = FALSE}
d_s1 %>% count(treat_real, contact)
```

--

.box-5[Does this affect the internal validity of the study?]

---
background-position: 50% 50%
class: left, bottom, inverse
.big[
When we assume...
]

---
# Other assumptions

.pull-left[
- We already talked about the **.darkorange[ignorability assumption]**


- **.darkorange[Stable Unit Treatment Value Assumption (SUTVA)]**:

  - No interference
  - No hidden variations of treatments
]

.pull-right[
.center[
![](https://media.giphy.com/media/xT5LMHsI58Q1ZpugPC/giphy.gif)]
]
---
# SUTVA: No interference

- *"The treatment applied to one unit does not affect the outcome for other units"*

--

- Imagine we have two individuals, 1 and 2:

  - $Z_1$ and $Z_2$ will be the treatment assignment for 1 and 2, respectively.
  
  - Under SUTVA:
  
  .box-3LA[$$(Y_2(0), Y_2(1)) \perp Z_1$$]
  

---
# SUTVA: No hidden variations of treatments

- *"An individual receiving an specific treatment level cannot receive different forms of that treatment."*

--

- Think about the headache example from last class:

  - Individual 1 gets a **.darkorange[new aspirin (aspirin +)]**
  - Individual 2 gets an **.darkorange[old aspirin (aspirin -)]**
  - Individual 3 doesn't get a pill
  
- If we label the treatments as $Z=0$ (doesn't get an aspirin) and $Z=1$ (gets an aspirin), **.darkorange[potential outcomes would change depending on whether they got *aspirin +* or *aspirin -*.]**



---
# When SUTVA hits the fan

.center2[
.box-7[When do you think SUTVA could fail?]
]
<br>
<br>
<br>
<br>
.bottom2[.lightgrey[h/t to @paul_gp]]

---
# When SUTVA hits the fan
<br>
<br>
<br>
.center[
.box-3[Network effects]
]
--
.center[
.box-5[General Equilibrium Effects]
]

---
# Network effects

- Also referred to as **.darkorange[spillovers]**

- Potential outcomes will depend on *who gets the treatment*

<br>
<br>
.box-2LA[Let's look at an example]

---
# Network effects

.center[
![:scale 80%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/networks1.png)
]


---
# Network effects

.center[
![:scale 80%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/networks2.png)
]

---
# Network effects

.center[
![:scale 80%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/networks3.png)
]

---
# Network effects

.center[
![:scale 80%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/networks4.png)
]

---
# Network effects

.center[
![:scale 80%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/networks5.png)
]

---
# Network effects

.box-6LA[Can we do something about this?]
<br>
<br>
<br>
--

1. **.darkorange[Randomize at a higher level]** (e.g. neighborhood, school, etc. instead of at the individual level)

--

  - Note that you will have to **.darkorange[cluster your standard errors]**

--

2. **.darkorange[Model the network!]**

---
# General Equilibrium Effects

- Usually arise when you **.darkorange[scale up]** a program or intervention.

- Imagine you want to test the effect of providing information about employment and expected income to students to see whether it affect their choice of university and/or major.

--
<br>
<br>
.box-7LA[What could happen if you offer it to everyone?]

---
background-position: 50% 50%
class: left, bottom, inverse
.big[
Show me the power
]

---
# Statistical power

- **.darkorange[Statistical power]** refers to the probability that a test correctly rejects the null hypothesis $H_0$, when $H_0$ is false.

  - It's related to sample size!

--

.box-6[Power = 1- Pr(Type II error)]

- **.darkorange[Type I error]**: Probability of rejecting the null hypothesis, when the null is true ($\alpha$).

- **.darkorange[Type II error]**: Probability of not rejecting the null hypothesis, when the null is false ($\beta$).

---
# Statistical power

- **.darkorange[Statistical power]** refers to the probability that a test correctly rejects the null hypothesis $H_0$, when $H_0$ is false.

  - It's related to sample size!


.box-6[Power = 1- Pr(Type II error)]

- **.darkorange[False Positive]**: Probability of rejecting the null hypothesis, when the null is true ($\alpha$).

- **.darkorange[False Negative]**: Probability of not rejecting the null hypothesis, when the null is false ($\beta$).

---
# Statistical power


.center[
![:scale 70%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/type_1_errors.png)]


---
# Statistical power


.center[
![:scale 90%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/type_2_errors.png)]

---
#Statistical power and sample size
.box-2t[How big of a sample?]

--

```{r fake-income-program, include=FALSE}
library(infer)

set.seed(1234)
fake_income_t <- tibble(Person = 1:200, 
                        Group = "Treatment",
                        Before = rnorm(200, mean = 200, sd = 70),
                        After = rnorm(200, mean = 250, sd = 70))

fake_income_c <- tibble(Person = 201:400, 
                        Group = "Control",
                        Before = rnorm(200, mean = 200, sd = 70),
                        After = rnorm(200, mean = 210, sd = 70))

fake_income <- bind_rows(fake_income_t, fake_income_c) %>% 
  mutate(Difference = After - Before) %>% 
  sample_frac(1)

fake_income_small <- fake_income %>% 
  group_by(Group) %>% 
  sample_n(5) %>% 
  ungroup()

diff_small <- fake_income_small %>% 
  specify(Difference ~ Group) %>% 
  calculate("diff in means", order = c("Treatment", "Control"))

boot_small <- fake_income_small %>% 
  specify(Difference ~ Group) %>% 
  hypothesize(null = "independence") %>% 
  generate(reps = 1000, type = "permute") %>% 
  calculate("diff in means", order = c("Treatment", "Control"))

p_small <- boot_small %>% 
  get_p_value(obs_stat = diff_small$stat, direction = "both") %>% 
  mutate(p_value_clean = scales::pvalue(p_value))

diff_big <- fake_income %>% 
  specify(Difference ~ Group) %>% 
  calculate("diff in means", order = c("Treatment", "Control"))

boot_big <- fake_income %>% 
  specify(Difference ~ Group) %>% 
  hypothesize(null = "independence") %>% 
  generate(reps = 1000, type = "permute") %>% 
  calculate("diff in means", order = c("Treatment", "Control"))

p_big <- boot_big %>% 
  get_p_value(obs_stat = diff_big$stat, direction = "both") %>% 
  mutate(p_value_clean = scales::pvalue(p_value))
```


.box-4t[A training program causes incomes to rise by $40]

.center.small[
```{r fake-income-example, echo=FALSE}
fake_income %>% 
  head(6) %>% 
  mutate(across(where(is.numeric), ~round(., 2))) %>% 
  knitr::kable(align = "llccc")
```
]

---
# Can I detect an effect?

.pull-left[
.center[
.box-5b[Enroll 10 participants]]

```{r power-small, echo=FALSE, fig.width=6, fig.height=4.5, out.width="100%"}

boot_small %>% 
  visualize() +
  geom_vline(xintercept = diff_big$stat, color = "#FF4136", size = 1) +
  labs(x = "Average treatment − Average control",
       y = "Count",
       title = "Simulated world with no difference",
       subtitle = paste0("N = 10; p = ", p_small$p_value_clean)) +
  theme_ipsum_fsc(plot_title_face = "bold",plot_title_size = 24) + #plain 
  theme(plot.margin=unit(c(1,1,1.5,1.2),"cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.line = element_line(colour = "dark grey"))+
  theme(axis.title.x = element_text(size=18),#margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.text.x = element_text(size=14),
        axis.title.y = element_text(size=18),#margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.text.y = element_text(size=14),legend.position="none",
        legend.title = element_blank(),
        legend.text = element_text(size=15),
        legend.background = element_rect(fill="white",colour ="white"),
        title = element_text(size=14))
```

]

--

.pull-right[
.center[.box-5b[Enroll 200 participants]]

```{r power-big, echo=FALSE, fig.width=6, fig.height=4.5, out.width="100%"}
boot_big %>% 
  visualize() +
  geom_vline(xintercept = diff_big$stat, color = "#FF4136", size = 1) +
  labs(x = "Average treatment − Average control",
       y = "Count",
       title = "Simulated world with no difference",
       subtitle = paste0("N = 200; p = ", p_big$p_value_clean)) +
  theme_ipsum_fsc(plot_title_face = "bold",plot_title_size = 24) + #plain 
  theme(plot.margin=unit(c(1,1,1.5,1.2),"cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.line = element_line(colour = "dark grey"))+
  theme(axis.title.x = element_text(size=18),#margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.text.x = element_text(size=14),
        axis.title.y = element_text(size=18),#margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.text.y = element_text(size=14),legend.position="none",
        legend.title = element_blank(),
        legend.text = element_text(size=15),
        legend.background = element_rect(fill="white",colour ="white"),
        title = element_text(size=14))
```

]


---
# What's the right sample size?

.box-6[Use a statistical power calculator to<br>make sure you can potentially detect an effect]

.center[
![:scale 50%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/power-search.png)
]

--

.box-7[Or you can use simulations!]

---
background-position: 50% 50%
class: left, bottom, inverse
.big[
Limitations and Potential Problems in Randomized Controlled Trials
]

---
# Generalizibility of RCTs

- External Validity vs Internal Validity:

  - **.darkorange[External validity]**: "The extent to which results can be generalized to other contexts or populations."
  
  - **.darkorange[Internal validity]**: "[T]he extent to which the observed results represent the truth in the population we are studying."

---
# External vs Internal Validity

.center[
![:scale 75%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/validity.png)]

--
- Many times, RCTs use **.darkorange[convenience samples]**

---
# Noncompliance and Attrition

.box-5[Attrition]

.box-5t[Units fall out of your sample]

- **.darkorange[Can you give an example?]**

---
# Noncompliance and Attrition

.box-5[Attrition]

.box-5t[Units fall out of your sample]

.box-7[Noncompliance]

.box-7t[Units that where assigned to one group end up in another]

- **.darkorange[Example?]**

---
# Noncompliance and Attrition

- If **.darkorange[attrition]** is correlated with the treatment, we're in trouble.

--

.box-3LA[WHY?]

---
# Noncompliance and Attrition

- If **.darkorange[attrition]** is correlated with the treatment, we're in trouble.


.box-3LA[The ignorability assumption can break!]

---
# Noncompliance and Attrition

- If **.darkorange[attrition]** is correlated with the treatment, we're in trouble.

.box-3LA[The ignorability assumption can break!]

- **.darkorange[Noncompliance]** is a problem for identifying $ATE$.

  - E.g. Treatment *assingment* is random, but not necessarily the *take-up* of the treatment
  
--
  
  - Stuck with **.darkorange[Intention to Treat (ITT) effect]**.

---
# Other problems to look out for

1. **.darkorange[Hawthorne effects]**:

  - Effect that occurs when people behave differently because they are being watched

--

2. **.darkorange[John Henry effects]**:

  - Effect that occurs when the control group works harder because they were not assigned to treatment.


---
# Feasibility

.pull-left[
- RCTs can be **.darkorange[expensive]** and also **.darkorange[slow]**.

- Organizations might **.darkorange[not be willing to randomize]**.
]

.pull-right[
.center[
![:scale 90%](https://media.giphy.com/media/1xkMJIvxeKiDS/giphy.gif)]
]
---
# Getting around some issues

- **.darkorange[Staggered adoption]**: Eventually treat everyone, but at different times.

  - You can think about this when you have panel data.

- **.darkorange[Randomize in the bubble]**:

  - Not randomize everyone, but maybe those that are on the margin of receiving the treatment.
  
---
background-position: 50% 50%
class: left, bottom, inverse
.big[
A/B Testing
]

---
# A/B Testing

.pull-left[
.center[
![](https://media.giphy.com/media/LmNwrBhejkK9EFP504/giphy.gif)]
]

.pull-right[
- A/B testing is very popular right now to test the effect of **.darkorange[small changes]** in products on an outcome of interest.

- E.g. In web development, user would be exposed to **.darkorange[different versions of the same website]** (only with subtle changes).

- Companies can quickly analyze the data, adapt their design, and continue testing features.
]

---
# A/B Testing Jargon

- There's a lot of jargon in A/B testing that is thrown out there...

.box-7[What does it all mean?]

--

.box-5t[Conversions]

.box-4t[Regret]

.box-2t[Multi-armed bandits/ Contextual bandits]

---
# A/B Testing Jargon

- **.darkorange[Conversions]**: "Cause the customer to take action"

- **.darkorange[Regret]**: Loss of conversion due to a low-performing treatment.
--

<br>
<br>
<br>
<br>
.box-7[Maximize conversions and minimize regret]

---
# A/B Testing Jargon

- **.darkorange[Multi-armed bandits/ Contextual bandits]**

  - Name comes from machines at casinos.
  - You want to maximize total payout $\rightarrow$ Balance between exploration and exploitation

.center[
![:scale 50%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/slot-machine.png)]
--

- **.darkorange[Multi-armed bandits]** redirect users to the more successful versions of the treatment.

- A **.darkorange[contextual bandit]** uses prior information from the user to select an action.

---
# A/B Testing in Data: MSU Library

- Montana University Library website: Low interaction with the "Interact" Category
.center[
![:scale 50%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/montana_control.png)]
---
# A/B Testing in Data: MSU Library
.center[
![:scale 50%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/heatmap_control.png)]

---
# A/B Testing in Data: Different treatments

- Test four different names for that category

.pull-left[
.center[
![:scale 80%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/connect.png)

![:scale 80%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/learn.png)]
]

.pull-right[
.center[
![:scale 80%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/help.png)

![:scale 80%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/services.png)]
]

---
# A/B Testing in Data: Analyze results

.center2[
.box-5LA[How would you analyze these results?]]

---
.center[
![:scale 100%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/google_analytics1.png)]
---
.center[
![:scale 100%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/google_analytics2.png)]
---
# Homepage click-through
.center[
![:scale 60%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/click_through.png)]
---
# Drop-off
.center[
![:scale 55%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/drop_off.png)]
---
# Homepage return
.center[
![:scale 55%](https://raw.githubusercontent.com/maibennett/sta235/main/exampleSite/content/Classes/Week5/1_RCT/images/homepage_return.png)]

---
# Wrapping things up

- Randomized controlled trials are great... **.darkorange[but not for everything!]**

--

- Randomization buys us **.darkorange[no systematic selection on observables or unobservables]**

  - But things can go wrong, too!
  
--

.box-6LA[Check your assumptions and look out for potential issues!]

<!-- pagedown::chrome_print('C:/Users/mc72574/Dropbox/Hugo/Sites/sta235/exampleSite/content/Classes/Week5/1_RCT/f2021_sta235h_8_RCT.html') -->
